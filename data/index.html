<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://api.map.baidu.com/getscript?v=2.0&ak=E4805d16520de693a3fe707cdc962045&services=&t=20190123111209"></script>
    <style type="text/css">
        * {
            padding: 0;
            margin: 0;
        }

        html,
        body {
            height: 100%;
        }

        #allmap {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="allmap"></div>
    <script>
        var map;
        var points = [
            [113.63623281091695,34.74863674608032],
            [113.63558644135101,34.75380086865398],
            [113.63477873796256,34.75396086473053],
            [113.63427098976821,34.753981966563046],
            [113.63383618446423,34.75405471723783],
            [113.6325969876398,34.75403636055147],
            [113.63156667955124,34.75416124693671],
            [113.6307000649562,34.75425422017503],
            [113.63020227698814,34.75431350268053],
            [113.62942307476719,34.75437988699206],
            [113.62869984027799,34.75441094458149],
            [113.6282989951733,34.75438127740893],
            [113.62787898951905,34.75442325362141],
            [113.62782601915704,34.754493886891524],
            [113.62779203339265,34.75499164995058],
            [113.62815533527072,34.755154766180446],
            [113.62833821278738,34.75576429600505],
            [113.62858171803684,34.75647214617089],
            [113.62873386967186,34.75703950777586],
            [113.6287440432901,34.757470942921536],
            [113.62878454752871,34.75776460660666],
            [113.62919257585845,34.75888905835843],
            [113.62932439010676,34.759187249711374],
            [113.62946391793808,34.75975739939035],
            [113.62970551377643,34.760263401896644],
            [113.62962528786728,34.76051182363649],
            [113.62976789496959,34.76083963021759],
            [113.62983761825254,34.76131836778579],
            [113.63008637082693,34.76215448738463],
            [113.63020631766047,34.762503965217334],
            [113.63048271882775,34.76348120399085],
            [113.63081449019262,34.76432763695182],
            [113.63126814596274,34.765242585241594],
            [113.63129165309363,34.76544153978764],
            [113.63133628384156,34.766036923040176],
            [113.631601281217,34.76606731486769],
            [113.63177603542766,34.76611101918599],
            [113.6318908987498,34.766124485907504],
            [113.63224854635999,34.76612436745068],
            [113.63377656504336,34.766002491502],
            [113.63431870099434,34.76586147065891],
            [113.63527324945403,34.76584442776994],
            [113.63603478894025,34.7657712661364],
            [113.63628405262796,34.76576095257166],
            [113.6369546445783,34.765712344573984],
            [113.63769827647432,34.765797331456326],
            [113.6387980500211,34.76610105049715],
            [113.639030636485,34.76623114696442],
            [113.63973600721351,34.76656673548129],
            [113.64001326805366,34.76673444534282],
            [113.64030309822844,34.76681389763928],
            [113.64082476975018,34.767154742239626],
            [113.6417017283201,34.76761177087915],
            [113.64139019214421,34.767916758973115],
            [113.64110590619345,34.768184203138205],
            [113.64057435950248,34.768755790822695],
            [113.6398671221322,34.76957546696444],
            [113.63971250206114,34.7697407118288],
            [113.64020004497529,34.770047745987924],
            [113.64078554580266,34.77040314903961],
            [113.64205544736363,34.77096823217514],
            [113.64234020114567,34.77121036253506],
            [113.64359268650813,34.77168638384288],
            [113.64456911812373,34.77222372678584],
            [113.64598066093357,34.7725921990592],
            [113.64715045429807,34.773018818666664],
            [113.64775817728854,34.77318506589665],
            [113.64864933751538,34.77355976218294],
            [113.65007469899035,34.774165830452034],
            [113.65032703585118,34.774290722683745],
            [113.65061301469112,34.77439495458529],
            [113.65173754132076,34.77449018541084],
            [113.65193785967917,34.774532930064055],
            [113.65295057342303,34.77441841279486],
            [113.65421342761081,34.77443286968343],
            [113.65542620030426,34.77438275302031],
            [113.65545254858468,34.77445649319726],
            [113.6556053925664,34.77449326002096],
            [113.65690406706817,34.774511062415485],
            [113.65818028958756,34.7744213961255],
            [113.65915717307962,34.774337004466275],
            [113.65992690326591,34.77446523408438],
            [113.66108544202208,34.77465250876732],
            [113.659266,34.774469],
            [113.658473,34.774428],
            [113.658325,34.774444],
            [113.658268,34.774461],
            [113.658268,34.774636],
            [113.65827,34.774748],
            [113.658265,34.776688],
            [113.658297,34.77711],
            [113.65851,34.77789],
            [113.658492,34.778719],
            [113.658342,34.779771],
            [113.658352,34.780027],
            [113.658242,34.780747],
            [113.658204,34.781655],
            [113.658266,34.782374],
            [113.658327,34.783287],
            [113.658429,34.783594],
            [113.658314,34.783599],
            [113.658496,34.783609],
            [113.658471,34.783564],
            [113.65919438364672,34.78352335925253],
            [113.661062,34.783619],
            [113.661207,34.783596],
            [113.662464,34.78362],
            [113.663835,34.783607],
            [113.665291,34.78373],
            [113.666513,34.783557],
            [113.66677,34.783691],
            [113.66774038095888,34.783739494002965],
            [113.66856586030123,34.78350956303247],
            [113.66955063341189,34.783753276088966],
            [113.67058908260913,34.78375722885279],
            [113.67195031505057,34.78403937593111],
            [113.67246183146254,34.78396586172771],
            [113.67303233206164,34.78395763450662],
            [113.6742177473344,34.78397137626795],
            [113.67517526579633,34.7838021647324],
            [113.67649652896745,34.783842986289876],
            [113.67746355705364,34.783528262877695],
            [113.67790169224476,34.78348042742019],
            [113.67911542525668,34.7835782011282],
            [113.6804144700599,34.783985289961414],
            [113.68175110107563,34.78366782155831],
            [113.68235461819611,34.78373313104776],
            [113.68239263548446,34.78364759923137],
            [113.68387221880434,34.783675839494606],
            [113.68471315509899,34.78371609342376],
            [113.68517439699684,34.78368466524816],
            [113.6852096774666,34.78372081320647],
            [113.68598286744846,34.783841531751804],
            [113.68714791090386,34.78366494833154],
            [113.68746397891366,34.78370008021308],
            [113.68870994543902,34.783666642513175],
            [113.68973964395587,34.783786360252996],
            [113.69088812358109,34.78374169883692],
            [113.69247461225861,34.78363230421],
            [113.69246778779103,34.78362017994586],
            [113.6927626834899,34.78352415536339],
            [113.69380722177989,34.7835942200969],
            [113.6950075152018,34.783679280305826],
            [113.69633289460107,34.783813819910065],
            [113.69751551499438,34.7836497894139],
            [113.69763877747076,34.78288863412589],
            [113.69756720440114,34.78239730502991],
            [113.69761536820039,34.781867635576205],
            [113.697741996951,34.781054618036336],
            [113.69779505042068,34.780329498980336],
            [113.69760903310934,34.779725447434394],
            [113.69751012019225,34.77942271767052],
            [113.69761900186631,34.77905271835347],
            [113.69769141921711,34.77822414910119],
            [113.69760026838306,34.777355918167835],
            [113.69756081835143,34.77706743814121],
            [113.69762524829984,34.77694874358812],
            [113.69790862164334,34.776967035570415],
            [113.69830166408315,34.777013303416275],
            [113.69841411929356,34.77702757961695],
        ];

        var newpoints = [
            [113.6426373304,34.7549640688],
            [113.6419909608,34.7601281914],
            [113.6411793301,34.760297105],
            [113.6406715819,34.7603182068],
            [113.6402367766,34.7603909575],
            [113.6389975798,34.7603726008],
            [113.6379672717,34.7604974872],
            [113.6371006571,34.7605904605],
            [113.6366028692,34.760649743],
            [113.6358236669,34.7607161273],
            [113.6351004325,34.7607471849],
            [113.6346995874,34.7607175177],
            [113.6342795817,34.7607594939],
            [113.6342266113,34.7608301272],
            [113.6341926256,34.7613278902],
            [113.6345492908,34.7614898195],
            [113.6347321683,34.7620993493],
            [113.6349756735,34.7628071995],
            [113.6351278252,34.7633745611],
            [113.6351379988,34.7638059962],
            [113.635178503,34.7640996599],
            [113.6355865314,34.7652241117],
            [113.6357183456,34.765522303],
            [113.6358578734,34.7660924527],
            [113.6360994693,34.7665984552],
            [113.6360192434,34.7668468769],
            [113.6361618505,34.7671746835],
            [113.6362315738,34.7676534211],
            [113.6364803263,34.7684895407],
            [113.6366002732,34.7688390185],
            [113.6368766743,34.7698162573],
            [113.6372084457,34.7706626903],
            [113.6376600191,34.7715736286],
            [113.6376835262,34.7717725831],
            [113.637728157,34.7723679664],
            [113.6379931544,34.7723983582],
            [113.6381679086,34.7724420625],
            [113.6382827719,34.7724555293],
            [113.6386404195,34.7724554108],
            [113.6401684382,34.7723335349],
            [113.6407105741,34.772192514],
            [113.6416693405,34.772170677],
            [113.64243088,34.7720975154],
            [113.6426801436,34.7720872019],
            [113.6433507356,34.7720385939],
            [113.6440943675,34.7721235807],
            [113.645194141,34.7724272998],
            [113.6454267275,34.7725573962],
            [113.6461320982,34.7728929848],
            [113.6464093591,34.7730606946],
            [113.6466991892,34.7731401469],
            [113.6472208608,34.7734809915],
            [113.6480978193,34.7739380202],
            [113.6477862832,34.7742430083],
            [113.6475019972,34.7745104524],
            [113.6469704505,34.7750820401],
            [113.6462632131,34.7759017162],
            [113.6461085931,34.7760669611],
            [113.646596136,34.7763739953],
            [113.6471816368,34.7767293983],
            [113.6484515384,34.7772944815],
            [113.6487362922,34.7775366118],
            [113.6499887775,34.7780126331],
            [113.6509652091,34.7785499761],
            [113.6524049401,34.7788202565],
            [113.6535747334,34.7792468761],
            [113.6541824564,34.7794131234],
            [113.6550736167,34.7797878196],
            [113.6564989781,34.7803938879],
            [113.656751315,34.7805187801],
            [113.6570372938,34.780623012],
            [113.6581618205,34.7807182429],
            [113.6583621388,34.7807609875],
            [113.6593748526,34.7806464703],
            [113.6606377068,34.7806609271],
            [113.66190433,34.7804531919],
            [113.6619306783,34.780526932],
            [113.6620835222,34.7805636989],
            [113.6633821967,34.7805815013],
            [113.6646584193,34.780491835],
            [113.6656353028,34.7804074433],
            [113.6664050329,34.7805356729],
            [113.6675635717,34.7807229476],
            [113.6657441297,34.7805394389],
            [113.6649511297,34.7804984389],
            [113.6648031297,34.7805144389],
            [113.6647461297,34.7805314389],
            [113.6647461297,34.7807064389],
            [113.6647481297,34.7808184389],
            [113.6647408632,34.782760396],
            [113.6647728632,34.783182396],
            [113.6649858632,34.783962396],
            [113.6649678632,34.784791396],
            [113.6648178632,34.785843396],
            [113.6648278632,34.786099396],
            [113.6647178632,34.786819396],
            [113.6646798632,34.787727396],
            [113.6647418632,34.788446396],
            [113.6648028632,34.789359396],
            [113.6649048632,34.789666396],
            [113.6647898632,34.789671396],
            [113.6649718632,34.789681396],
            [113.6649468632,34.789636396],
            [113.6656702468,34.7895957553],
            [113.6675378632,34.789691396],
            [113.6676828632,34.789668396],
            [113.6689398632,34.789692396],
            [113.6703108632,34.789679396],
            [113.6718224209,34.7896272355],
            [113.6730444209,34.7894542355],
            [113.6733014209,34.7895882355],
            [113.6742718018,34.7896367295],
            [113.6750972812,34.7894067986],
            [113.6760820543,34.7896505116],
            [113.6771205035,34.7896544644],
            [113.6784817359,34.7899366115],
            [113.6789932523,34.7898630973],
            [113.6795637529,34.78985487],
            [113.6807491682,34.7898686118],
            [113.681753135,34.7895530979],
            [113.6830743982,34.7895939195],
            [113.6840414262,34.7892791961],
            [113.6844795614,34.7892313606],
            [113.6856932944,34.7893291343],
            [113.6869923393,34.7897362231],
            [113.6883289703,34.7894187547],
            [113.6889324874,34.7894840642],
            [113.6889705047,34.7893985324],
            [113.690450088,34.7894267727],
            [113.6912910243,34.7894670266],
            [113.6917769184,34.7893529148],
            [113.6918121988,34.7893890628],
            [113.6925853888,34.7895097813],
            [113.6937504323,34.7893331979],
            [113.6940665003,34.7893683298],
            [113.6953124668,34.7893348921],
            [113.6963421653,34.7894546098],
            [113.697490645,34.7894099484],
            [113.6990771336,34.7893005538],
            [113.6990703092,34.7892884295],
            [113.6993652049,34.789192405],
            [113.7004097432,34.7892624697],
            [113.7016055828,34.7893577181],
            [113.7029309622,34.7894922577],
            [113.7041135826,34.7893282272],
            [113.704236845,34.7885670719],
            [113.704165272,34.7880757428],
            [113.7042134358,34.7875460734],
            [113.7043400645,34.7867330558],
            [113.704393118,34.7860079368],
            [113.7042071007,34.7854038852],
            [113.7041081878,34.7851011555],
            [113.7042170694,34.7847311561],
            [113.7042894868,34.7839025869],
            [113.7041983359,34.783034356],
            [113.7041588859,34.7827458759],
            [113.7042233159,34.7826271814],
            [113.7045066892,34.7826454734],
            [113.7048997316,34.7826917412],
            [113.7050121869,34.7827060174],
        ];

        function initMap() {
            map = new BMap.Map('allmap');
            let [lng, lat] = points[0];
            var point = new BMap.Point(lng, lat);
            map.centerAndZoom(point, 15);
            map.enableScrollWheelZoom(true);
        }

        function addPoint(lng, lat) {
            return new BMap.Point(lng, lat);
        }

        function drawLine(points) {
            var line = new BMap.Polyline(points, { strokeColor: 'red', strokeWeight: 2, strokeOpacity: 0.8 });
            map.addOverlay(line);
            return line;
        }

        function addMarker(point) {
            var marker = new BMap.Marker(point);
            map.addOverlay(marker);
            return marker;
        }

        const drawPoint = async points => {
            let pts = [];
            for (let i in points) {
                // let point = await getLocation(points[i]);
                let point = points[i];
                if(points) {
                    let [lng, lat] = point;
                    // console.log(lng + ',' + lat);
                    let pt = addPoint(lng, lat);
                    pts.push(pt);
                    addMarker(pt);
                }
            }
            drawLine(pts);
            console.log(pts.length);
        }

        const getLocation = point => {
            return new Promise(resolve => {
                let data = {
                lng: point[0],
                lat: point[1]
                }
                fetch('http://localhost:3000/api/location', {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json; charset=utf-8'
                },
                body: JSON.stringify(data)
                })
                .then(res => res.json())
                .then(res => {
                if(res.status == 200) {
                    let { lng, lat } = res.result[0];
                    setTimeout(() => {
                        resolve({
                            lng: lng[2],
                            lat: lat[2]
                        })
                    }, 100);
                }
                else {
                    resolve(null)
                }
                })
                .catch(err => {
                    resolve(null)
                })
            })
        }

        initMap()
        drawPoint(newpoints)
    </script>
</body>

</html>